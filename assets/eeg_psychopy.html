
<!DOCTYPE html>
  <html>
    <head>
      <title>eyetracking</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/songtengyu/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.13/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><html><head><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body></body></html>
    </head>
    <body for="html-export" >
      <div class="crossnote markdown-preview  "  >
      
<h1 id="add-eeg-recording-to-any-existing-psychopy-experiment-in-builder">Add EEG recording to any existing Psychopy experiment in Builder </h1>
<p>This is a short guide on how to add <strong>EEG recording</strong> to any existing Psychopy experiment. This guide is based on my experience using <code>muse-lsl</code> and the code component of Psychopy. This method doesn't require to run multiple scripts or use any external software. Also using this method the experiment can still be viewed and modified in <strong>Psychopy Builder</strong>.</p>
<p>You don't need to be an expert in Python to follow this guide, but you should have set up Python and Psychopy correctly on your computer.</p>
<p>To test whether you have correctly set up the computer, try open a terminal window (e.g. Powershell) and run commands <code>python</code> and <code>pip</code> to see if your python environment is working. If it is, we can start by installing <code>muse-lsl</code>.</p>
<h2 id="step-1-install-muse-lsl">Step 1: Install muse-lsl </h2>
<p><code>muse-lsl</code> is a Python package that allows you to stream EEG data from the Muse headband. We can install it using pip. In the terminal window type:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>pip <span class="token function">install</span> muse-lsl
</code></pre><p>and press <code>Enter</code>. It should automatically install all the dependencies.</p>
<h2 id="step-2-write-python-script-to-start-eeg-streaming">Step 2: Write python script to start EEG streaming </h2>
<p>This is the only python script we need outside of Psychopy. During the experiment we need to run the scirpt to connect to the Muse headband and start streaming the EEG data.</p>
<p>Use any text editor to create a new file in your experiment folder and name it <code>start_eeg_stream.py</code>. Copy and paste the following code into the file:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-import">import</span> sys
<span class="token keyword keyword-import">import</span> time
<span class="token keyword keyword-from">from</span> muselsl <span class="token keyword keyword-import">import</span> stream<span class="token punctuation">,</span> list_muses
<span class="token keyword keyword-import">import</span> datetime

<span class="token keyword keyword-def">def</span> <span class="token function">restart_script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Restarting script..."</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>execl<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>executable<span class="token punctuation">,</span> <span class="token operator">*</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>

<span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Attempt to connect and stream from the Muse</span>
        muses <span class="token operator">=</span> list_muses<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'bgapi'</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> muses<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> Starting Muse streaming..."</span></span><span class="token punctuation">)</span>
            stream<span class="token punctuation">(</span>muses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ppg_enabled<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> acc_enabled<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> gyro_enabled<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> backend<span class="token operator">=</span><span class="token string">'bgapi'</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"No Muse devices found. Restarting..."</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># Give some time before restarting</span>
            restart_script<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> Error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># Give some time before restarting</span>
        restart_script<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><blockquote>
<p>If you are using Bluetooth to connect to the Muse headband, you should delete the <code>backend='bgapi'</code> argument from the <code>stream</code> function.</p>
</blockquote>
<p>The code above can handle disconnections and other errors that might occur during the experiment. It will keep trying to connect to the Muse headband until it succeeds.</p>
<p>To run the script, open a Powershell window and navigate to the folder where the script is located. To do this, type</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">cd</span> <span class="token string">'path\to\your\experiment'</span>
</code></pre><p>You should replace <code>path\to\your\experiment</code> with the actual path to your experiment folder. If you don't know how to find the path, first open the folder in file explorer, then click on the address bar there you will see the path to the folder. Copy and paste it should do the work.</p>
<p>After you are in the correct folder, your Powershell window should look like this:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>PS C:\path\to\your\experiment&gt;
</code></pre><p>Then, you can run the script by running the following command:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>python start_eeg_stream.py
</code></pre><h2 id="step-3-add-code-component-to-your-psychopy-experiment">Step 3: Add code component to your Psychopy experiment </h2>
<p>Now open your experiment in Psychopy Builder and add a code component in any routine (preferably the first one). In the <strong>before experiment</strong> tab, copy and paste the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment">## ! -----------IMPORT  --------------</span>
<span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime
<span class="token keyword keyword-import">import</span> csv
<span class="token keyword keyword-import">import</span> pandas <span class="token keyword keyword-as">as</span> pd
<span class="token keyword keyword-import">import</span> re
<span class="token keyword keyword-import">import</span> time
<span class="token keyword keyword-from">from</span> pylsl <span class="token keyword keyword-import">import</span> StreamInlet<span class="token punctuation">,</span> resolve_byprop<span class="token punctuation">,</span> StreamInfo<span class="token punctuation">,</span> StreamOutlet<span class="token punctuation">,</span> StreamInlet<span class="token punctuation">,</span> resolve_stream
<span class="token keyword keyword-import">import</span> queue
<span class="token keyword keyword-import">import</span> threading
<span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-import">import</span> random

<span class="token comment">## ---------- EEG-------------</span>
output_types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'EEG'</span><span class="token punctuation">,</span> <span class="token string">'PPG'</span><span class="token punctuation">,</span> <span class="token string">'ACC'</span><span class="token punctuation">,</span> <span class="token string">'GYRO'</span><span class="token punctuation">]</span>

folder_path_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> output_type <span class="token keyword keyword-in">in</span> output_types<span class="token punctuation">:</span>
    folder_path_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'data/'</span> <span class="token operator">+</span> output_type <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-for">for</span> folder <span class="token keyword keyword-in">in</span> folder_path_list<span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>folder<span class="token punctuation">)</span>

<span class="token comment"># Function to record streams</span>
<span class="token keyword keyword-def">def</span> <span class="token function">record_stream_thread</span><span class="token punctuation">(</span>marker_queue<span class="token punctuation">,</span> stream_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">output_csv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> data<span class="token punctuation">,</span> channel_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> out<span class="token punctuation">:</span>
            csv_out <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
            csv_out<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Timestamp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> channel_names <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'Marker'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> data<span class="token punctuation">:</span>
                csv_out<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>row<span class="token punctuation">)</span>
    data_combine <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    marker <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    channel_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            stream <span class="token operator">=</span> resolve_stream<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> stream_type<span class="token punctuation">)</span>
            inlet <span class="token operator">=</span> StreamInlet<span class="token punctuation">(</span>stream<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>channel_names<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                inlet_info <span class="token operator">=</span> inlet<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
                Nchan <span class="token operator">=</span> inlet_info<span class="token punctuation">.</span>channel_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
                channel <span class="token operator">=</span> inlet_info<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>child<span class="token punctuation">(</span><span class="token string">'channels'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first_child<span class="token punctuation">(</span><span class="token punctuation">)</span>
                channel_names <span class="token operator">=</span> <span class="token punctuation">[</span>channel<span class="token punctuation">.</span>child_value<span class="token punctuation">(</span><span class="token string">'label'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Nchan<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    channel <span class="token operator">=</span> channel<span class="token punctuation">.</span>next_sibling<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    channel_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>channel<span class="token punctuation">.</span>child_value<span class="token punctuation">(</span><span class="token string">'label'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> marker_queue<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    task <span class="token operator">=</span> marker_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword keyword-if">if</span> task<span class="token punctuation">[</span><span class="token string">'command'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'SAVE'</span><span class="token punctuation">:</span>
                        output_path <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
                        output_csv<span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> data_combine<span class="token punctuation">,</span> channel_names<span class="token punctuation">)</span>
                        <span class="token keyword keyword-return">return</span>
                    <span class="token keyword keyword-elif">elif</span> task<span class="token punctuation">[</span><span class="token string">'command'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'MARKER'</span><span class="token punctuation">:</span>
                        marker <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                    sample<span class="token punctuation">,</span> timestamp <span class="token operator">=</span> inlet<span class="token punctuation">.</span>pull_sample<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
                    <span class="token keyword keyword-if">if</span> sample<span class="token punctuation">:</span>
                        tmp_tuple <span class="token operator">=</span> <span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>marker<span class="token punctuation">,</span><span class="token punctuation">)</span>
                        data_combine<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp_tuple<span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'Trying to reconnecting to stream'</span><span class="token punctuation">,</span> stream_type<span class="token punctuation">)</span>
            <span class="token keyword keyword-continue">continue</span>

eeg_marker_queue <span class="token operator">=</span> <span class="token boolean">None</span>
ppg_marker_queue <span class="token operator">=</span> <span class="token boolean">None</span>
acc_marker_queue <span class="token operator">=</span> <span class="token boolean">None</span>
gyro_marker_queue <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword keyword-if">if</span> <span class="token string">'EEG'</span> <span class="token keyword keyword-in">in</span> output_types<span class="token punctuation">:</span>
    eeg_marker_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-if">if</span> <span class="token string">'PPG'</span> <span class="token keyword keyword-in">in</span> output_types<span class="token punctuation">:</span>
    ppg_marker_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-if">if</span> <span class="token string">'ACC'</span> <span class="token keyword keyword-in">in</span> output_types<span class="token punctuation">:</span>
    acc_marker_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-if">if</span> <span class="token string">'GYRO'</span> <span class="token keyword keyword-in">in</span> output_types<span class="token punctuation">:</span>
    gyro_marker_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>

marker_queue_list_not_none <span class="token operator">=</span> <span class="token punctuation">[</span>queue <span class="token keyword keyword-for">for</span> queue <span class="token keyword keyword-in">in</span> <span class="token punctuation">[</span>eeg_marker_queue<span class="token punctuation">,</span> ppg_marker_queue<span class="token punctuation">,</span> acc_marker_queue<span class="token punctuation">,</span> gyro_marker_queue<span class="token punctuation">]</span> <span class="token keyword keyword-if">if</span> queue <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">add_queue</span><span class="token punctuation">(</span>new_instr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> queue <span class="token keyword keyword-in">in</span> marker_queue_list_not_none<span class="token punctuation">:</span>
        queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>new_instr<span class="token punctuation">)</span>
</code></pre><p>Note that we are recording all four streams of data from the Muse headband (EEG, PPG, ACC, GYRO). If you don't need all of them, you can remove the unnecessary ones from the list variable <code>output_types</code>.</p>
<p>Then, In the <strong>begin experiment</strong> tab of the same code component, copy and paste the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>recording_threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> stream_type<span class="token punctuation">,</span> marker_queue <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>output_types<span class="token punctuation">,</span> marker_queue_list_not_none<span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>record_stream_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>marker_queue<span class="token punctuation">,</span> stream_type<span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    recording_threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
</code></pre><p>Then, in the <strong>end experiment</strong> tab, copy and paste the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Save eeg data</span>
eeg_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'_muse'</span>
<span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>folder_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    eeg_tmp_path <span class="token operator">=</span> folder_path_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> eeg_filename <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> output_types<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.csv'</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'Saving {} data to {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>output_types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> eeg_tmp_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    marker_queue_list_not_none<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'command'</span><span class="token punctuation">:</span> <span class="token string">'SAVE'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> eeg_tmp_path<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword keyword-for">for</span> t <span class="token keyword keyword-in">in</span> recording_threads<span class="token punctuation">:</span>
    t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># save shuffled question data</span>
question_shuffled_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'_question.csv'</span>
question_shuffled_path <span class="token operator">=</span> question_shuffle_folder_path<span class="token operator">+</span>question_shuffled_filename
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'Saving question data to {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>question_shuffled_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
question_shuffled<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>question_shuffled_path<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword keyword-for">for</span> t <span class="token keyword keyword-in">in</span> recording_threads<span class="token punctuation">:</span>
    t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>The output will be saved in subfolders in the <code>data</code> folder of your experiment. The structure of the data folder will look like this:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>data/
    EEG/
        your_experiment_name_muse_EEG.csv
    PPG/
        your_experiment_name_muse_PPG.csv
    ACC/
        your_experiment_name_muse_ACC.csv
    GYRO/
        your_experiment_name_muse_GYRO.csv
</code></pre><h2 id="step-4-send-markers-to-the-eeg-recording-threads">Step 4: Send markers to the EEG recording threads </h2>
<p>At any time of your experiment, you can send markers to the EEG recording threads using the <code>add_queue</code> function.</p>
<p>For example, if the routine is called <code>trial</code> and it has a image component called <code>stimulus</code> which starts at the beginning of the routine and ends at the end of the routine, you can use the following code to send the marker as soon as the image component starts:</p>
<p>In the <strong>Begin Routine</strong> tab of the code component in the <code>trial</code> routine, copy and paste the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>markerSent <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre><p>Then, in the <strong>Each Frame</strong> tab of the same code component, copy and paste the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-if">if</span> stimulus<span class="token punctuation">.</span>status <span class="token operator">==</span> STARTED <span class="token keyword keyword-and">and</span> <span class="token keyword keyword-not">not</span> markerSent<span class="token punctuation">:</span>
    add_queue<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'command'</span><span class="token punctuation">:</span> <span class="token string">'MARKER'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    markerSent <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre><p>The code above will send the marker <code>1</code> as soon as the image component <code>stimulus</code> starts. You can replace <code>1</code> with any marker you want to send. Or you can define a marker query function to find the marker you want to send based on a pre-defined Excel spreadsheet and the current condition of the experiment. Here is an example of how to do it:</p>
<p>Suppose you defined your markers in a Excel file with the following structure:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>| image      | condition | marker |
|------------|-----------|--------|
| 1.png      | T1        | 1      |
| 1.png      | T2        | 2      |
| 2.png      | T1        | 3      |
| 2.png      | T2        | 4      |
</code></pre><pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">marker_query</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> condition<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Load the Excel file</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'path/to/your/excel/file.xlsx'</span><span class="token punctuation">)</span>
    <span class="token comment"># Find the marker based on the trial number and condition</span>
    marker <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span> <span class="token operator">==</span> image<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'condition'</span><span class="token punctuation">]</span> <span class="token operator">==</span> condition<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'marker'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-return">return</span> marker
</code></pre><p>Where <code>image</code> and <code>condition</code> are the current image shown and condition of the experiment. You can replace them with the actual variables you are using in your experiment. In most cases it can be the path to the image/video that is shown in the trial.</p>
<p>Then, you can modify the <code>add_queue</code> function in the <strong>Each Frame</strong> tab with the following code:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>add_queue<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'command'</span><span class="token punctuation">:</span> <span class="token string">'MARKER'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> marker_query<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">'T1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>In this case, you don't have to manually change the marker for each trial. The marker will be automatically selected based on the current trial number and condition of the experiment.</p>
<h2 id="step-5-start-the-eeg-stream-and-run-the-experiment">Step 5: Start the EEG stream and run the experiment </h2>
<p>There might be some bugs in the code that you need to fix. And sometimes in order to get the marker query to work you need some extra code. But if you follow the guide correctly, you should be able to start the EEG stream and collect the data. If you encounter any problems, feel free to ask for help through my <a href="mailto:ts3464@columbia.edu">Email</a>. Good Luck!</p>

      </div>
      
      
    </body>
    
    
    
    
    
  </html>